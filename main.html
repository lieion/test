<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="components/piechart.js"></script>
    <script src="components/subhistogram.js"></script>
    <script src="components/subhistogram2.js"></script>
    <script src="components/subscatterplot.js"></script>
    <script src="components/linechart.js"></script>
    <script src="components/subdatatable.js"></script>

    <title>Final Project</title>
    <style>
        body {
            background: #eee;
            overflow-y: scroll;
        }

        .container {
            width: 1300px;
            background: white;
        }

        .brushed {
            stroke-width: 1;
            stroke: gray;
            r: 5;
        }

        .custom-table {
            width: 100%;
            height: 100%;
            display: block;
            overflow: auto;
        }
    </style>
</head>

<body>
    <main class="container pb-3">
        <div class="row pt-2">
            <div class="col-1 text-end pe-2"><strong>Year:</strong></div>
            <div class="col-11">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="y-encoding" value="2017" id="y-2017">
                    <label class="form-check-label" for="x-sl">2017</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="y-encoding" value="2018" id="y-2018" checked>
                    <label class="form-check-label" for="x-sw">2018</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="y-encoding" value="2019" id="y-2019">
                    <label class="form-check-label" for="x-pl">2019</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="y-encoding" value="2020" id="y-2020">
                    <label class="form-check-label" for="x-pw">2020</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="y-encoding" value="2021" id="y-2021">
                    <label class="form-check-label" for="x-pw">2021</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="y-encoding" value="2022" id="y-2022">
                    <label class="form-check-label" for="x-pw">2022</label>
                </div>
                <!-- <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="y-encoding" value="all" id="y-0">
                    <label class="form-check-label" for="x-pw">All</label>
                </div> -->
            </div>

        </div>
        <div class="row">
            <div class="col-1 text-end pe-2"><strong>Month:</strong></div>
            <div class="col-11">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="1" id="m-jan"
                        checked>
                    <label class="form-check-label" for="y-sw">1月</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="2" id="m-feb">
                    <label class="form-check-label" for="y-pl">2月</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="3" id="m-mar">
                    <label class="form-check-label" for="y-pw">3月</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="4" id="m-apr">
                    <label class="form-check-label" for="y-pw">4月</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="5" id="m-may">
                    <label class="form-check-label" for="y-pw">5月</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="6" id="m-jun">
                    <label class="form-check-label" for="y-pw">6月</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="7" id="m-jul">
                    <label class="form-check-label" for="y-pw">7月</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="8" id="m-aug">
                    <label class="form-check-label" for="y-pw">8月</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="9" id="m-sep">
                    <label class="form-check-label" for="y-pw">9月</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="10" id="m-oct">
                    <label class="form-check-label" for="y-pw">10月</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="11" id="m-nov">
                    <label class="form-check-label" for="y-pw">11月</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="12" id="m-dec">
                    <label class="form-check-label" for="y-pw">12月</label>
                </div>
                <!-- <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="m-encoding" value="0" id="m-all">
                    <label class="form-check-label" for="y-pw">All</label>
                </div> -->

            </div>
        </div>
        <br>
        <div class="text-center">
            <svg width="400" height="400" id="piechart">
            </svg>
            <div class="tooltip bs-tooltip-top show" id="pc-tooltip" role="tooltip" style="display:none">
                <div class="tooltip-arrow"></div>
                <div class="tooltip-inner">
                    Some tooltip text!
                </div>
            </div>
        </div>
        
        <div class="text-center">
            <svg width="400" height="400" id="histogram">
            </svg>
            <svg width="400" height="400" id="histogram2">
            </svg>

        </div>

        <div class="contatiner" id="sc-ratio">
            <div class="row pt-2">
                <div class="col-1 text-end pe-2"><strong>Week:</strong></div>
                <div class="col-11">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="type-encoding" value="midweek" id="y-mi">
                        <label class="form-check-label" for="x-sl">midweek</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="type-encoding" value="weekend" id="y-we">
                        <label class="form-check-label" for="x-sw">weekend</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="type-encoding" value="total" id="y-tot" checked>
                        <label class="form-check-label" for="x-pl">total</label>
                    </div>
                </div>
    
            </div>
        </div>

        <div class="container text-center">
            <div class="row">
            
              <div class="col-md-8">
                <svg width="800" height="400" id="subscatterplot"></svg>
                <div class="tooltip bs-tooltip-top show" id="sc-tooltip" role="tooltip" style="display:none">
                  <div class="tooltip-arrow"></div>
                  <div class="tooltip-inner">
                    Some tooltip text!
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <table id="stationdata" class="table custom-table" >
                    <thead>
                        <tr>
                          <th scope="col">항목</th>
                          <th scope="col">내용</th>
                        </tr>
                      </thead>
                    <tbody>
                      <tr>
                        <th scope="row">호선</th>
                        <td>-</td>
                      </tr>
                      <tr>
                        <th scope="row">역명</th>
                        <td>-</td>
                      </tr>
                      <tr>
                        <th scope="row">승차</th>
                        <td>-</td>
                      </tr>
                      <tr>
                        <th scope="row">하차</th>
                        <td>-</td>
                      </tr>
                    </tbody>
                </table>
              </div>
            </div>
        </div>
                
        <div class="text-center">
            
            <svg width="400" height="400", id="linechart">

            </svg>
        </div>
        <!-- ["날짜","구분","05~06","06~07","07~08","08~09","09~10","10~11","11~12","12~13","13~14","14~15","15~16","16~17","17~18","18~19","19~20","20~21","21~22","22~23","23~24","24~01","Total"] -->
        <div id="totaltable" style="overflow: auto">
            <table class="table table-striped text-center">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>5~6</th>
                        <th>6~7</th>
                        <th>7~8</th>
                        <th>8~9</th>
                        <th>10~11</th>
                        <th>11~12</th>
                        <th>12~13</th>
                        <th>13~14</th>
                        <th>14~15</th>
                        <th>15~16</th>
                        <th>16~17</th>
                        <th>17~18</th>
                        <th>18~19</th>
                        <th>19~20</th>
                        <th>20~21</th>
                        <th>21~22</th>
                        <th>22~23</th>
                        <th>23~24</th>
                        <th>24~1</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody id="data-table">

                </tbody>
            </table>
        </div>
    </main>
    <script>
        let data,piechart,clickedLines,histogram,histogram2,scatterplot,clickedCircleInfo,lineChart;
        let inclickedData,outclickedData,dataTable;
        let clickedNum=-1;
        let monthyear = -1; //month -1 year 1
        const table = document.getElementById("stationdata");
        const scat = document.getElementById("subscatterplot");
        const linect = document.getElementById("linechart");
        const scradio = document.getElementById("sc-ratio");
        const dtble = document.getElementById("totaltable");
        const lineCell = table.rows[1].cells[1];   // 호선 셀
        const stationCell = table.rows[2].cells[1];   // 역명 셀
        const boardCell = table.rows[3].cells[1];   // 승차 셀
        const alightCell = table.rows[4].cells[1];   // 하차 셀
        scat.style.display = "none"
        table.style.display = "none"
        scradio.style.display = "none"
        dtble.style.display = "none"
        function updateSubHistogramByRadioLine(){
            let yVar = d3.select("input[type=radio][name=y-encoding]:checked").property("value");
            let mVar = d3.select("input[type=radio][name=m-encoding]:checked").property("value");
            histogram2.update({},yVar,mVar,clickedLines[0]["호선"]);
        }
        function updateSubHistogramByRadioYear(){
            let yVar = d3.select("input[type=radio][name=y-encoding]:checked").property("value");
            let mVar = d3.select("input[type=radio][name=m-encoding]:checked").property("value");
            histogram2.update({},yVar,mVar,0);
        }

        


        function updateSubHistogram(){
            // console.log(data[+y])
            let yVar = d3.select("input[type=radio][name=y-encoding]:checked").property("value");
            let mVar = d3.select("input[type=radio][name=m-encoding]:checked").property("value");
            histogram.update(clickedLines,yVar,mVar,1);
        }
        function updateSubHistogramTotal(){
            // console.log(data[+y])
            let yVar = d3.select("input[type=radio][name=y-encoding]:checked").property("value");
            let mVar = d3.select("input[type=radio][name=m-encoding]:checked").property("value");
            let zVar = data[+yVar-2017].filter(d=> (+d["날짜"].split("-")[1]===+mVar))
            histogram.update(zVar,yVar,mVar,1);
        }

        function updatePieChart() {
            console.log("h")
            let yVar = d3.select("input[type=radio][name=y-encoding]:checked").property("value");
            let mVar = d3.select("input[type=radio][name=m-encoding]:checked").property("value");
            piechart.update(yVar, mVar);
            clickedNum = -1
        }
        
        function updateHistorgramHighlight(){
            let mVar = d3.select("input[type=radio][name=m-encoding]:checked").property("value");
            histogram2.fillingHighlight(mVar)
        }

        function updateSubScatterPlot(){
            linect.style.display="none";
            dtble.style.display = "none"
            scradio.style.display = ""
            console.log("change")
            stationCell.textContent = "-";   // 역명 내용 변경
            boardCell.textContent ="-";   // 승차 내용 변경
            alightCell.textContent = "-";   // 하차 내용 변경
            let wVar = d3.select("input[type=radio][name=type-encoding]:checked").property("value");
            if(clickedLines) subscatterplot.update(clickedLines,wVar);
        }
        
        function ychange()
        {
            updatePieChart()
            updateSubHistogramByRadioYear()
            updateSubHistogramTotal()
            linect.style.display="none";
            dtble.style.display = "none"
            lineCell.textContent = "-";   // 호선 내용 변경
            stationCell.textContent = "-";   // 역명 내용 변경
            boardCell.textContent ="-";   // 승차 내용 변경
            alightCell.textContent = "-";   // 하차 내용 변경
            scat.style.display = "none"
            table.style.display = "none"
            scradio.style.display = "none"
        }

        function mchange()
        {
            console.log(clickedNum)
            linect.style.display="none";
            scat.style.display = "none"
            table.style.display = "none"
            scradio.style.display = "none"
            dtble.style.display = "none"
            if(clickedNum===1)
            {
                updatePieChart()
                updateSubHistogramByRadioYear()
                updateSubHistogramTotal()
                clickedNum=0
            }
            else{
                updatePieChart()
                updateHistorgramHighlight()
                updateSubHistogramTotal()
            }
        }
        
        function updateLineChart(){
            let wVar = d3.select("input[type=radio][name=type-encoding]:checked").property("value");
            if(wVar === "midweek") lineChart.update(clickedCircleInfo,0)
            else if(wVar === "weekend") lineChart.update(clickedCircleInfo,1)
            else if(wVar === "total") lineChart.update(clickedCircleInfo,2)
        }

        function updateDataTable(){
            dtble.style.display = ""
            if(clickedCircleInfo) dataTable.update(clickedCircleInfo);
        }

        //derive csv from github save
        Promise.all([
            d3.csv("https://raw.githubusercontent.com/lieion/test/main/src/subway_2017.csv"),
            d3.csv("https://raw.githubusercontent.com/lieion/test/main/src/subway_2018.csv"),
            d3.csv("https://raw.githubusercontent.com/lieion/test/main/src/subway_2019.csv"),
            d3.csv("https://raw.githubusercontent.com/lieion/test/main/src/subway_2020.csv"),
            d3.csv("https://raw.githubusercontent.com/lieion/test/main/src/subway_2021.csv"),
            d3.csv("https://raw.githubusercontent.com/lieion/test/main/src/subway_2022.csv"),
        ])
        .then(csvData => {
            csvData.forEach(f => {
                f.forEach(d=>{
                    d["05~06"] = +d["05~06"];
                    d["06~07"] = +d["06~07"];
                    d["07~08"] = +d["07~08"];
                    d["08~09"] = +d["08~09"];
                    d["09~10"] = +d["09~10"];
                    d["10~11"] = +d["10~11"];
                    d["11~12"] = +d["11~12"];
                    d["12~13"] = +d["12~13"];
                    d["13~14"] = +d["13~14"];
                    d["14~15"] = +d["14~15"];
                    d["15~16"] = +d["15~16"];
                    d["16~17"] = +d["16~17"];
                    d["17~18"] = +d["17~18"];
                    d["18~19"] = +d["18~19"];
                    d["19~20"] = +d["19~20"];
                    d["20~21"] = +d["20~21"];
                    d["21~22"] = +d["21~22"];
                    d["22~23"] = +d["22~23"];
                    d["23~24"] = +d["23~24"];
                    d["24~01"] = +d["24~01"];
                    d["Total"] = +d["Total"];
                });
            });
            data = csvData;
            piechart = new PieChart("#piechart", "#pc-tooltip", data);
            piechart.initialize();

            updatePieChart();
            

            piechart.on("click", (clickedItems) => {
                clickedNum = 1
                clickedLines=clickedItems;
                dtble.style.display = "none"
                updateSubHistogram();
                updateSubHistogramByRadioLine();
                updateSubScatterPlot();
                scat.style.display = "block"
                table.style.display = "block"
                // console.log(clickedLines);
                lineCell.textContent = clickedLines[0]["호선"];   // 호선 내용 변경
                stationCell.textContent = "-";   // 역명 내용 변경
                boardCell.textContent ="-";   // 승차 내용 변경
                alightCell.textContent = "-";   // 하차 내용 변경
            });

            histogram2 = new SubHistogram2("#histogram",data);
            histogram2.initialize();

            updateSubHistogramByRadioYear();

            histogram = new SubHistogram("#histogram2",data);
            histogram.initialize();
            updateSubHistogramTotal();
            
            d3.selectAll("input[type=radio][name=y-encoding]").on("change", ychange);
            d3.selectAll("input[type=radio][name=m-encoding]").on("change", mchange);
            d3.selectAll("input[type=radio][name=type-encoding]").on("change", updateSubScatterPlot);
            subscatterplot= new SubScatterplot("#subscatterplot", "#sc-tooltip");
            subscatterplot.initialize();
        
            subscatterplot.on("click",(clickedCircle)=>{
                clickedCircleInfo=clickedCircle
                inclickedData=subscatterplot.gdatax;
                outclickedData=subscatterplot.gdatay;
                
                lineCell.textContent = clickedCircleInfo[0]["호선"];   // 호선 내용 변경
                stationCell.textContent = clickedCircleInfo[0]["역명"];   // 역명 내용 변경
                boardCell.textContent =subscatterplot.resultofin;
                alightCell.textContent = subscatterplot.resultofout;
                
                updateLineChart();
                updateDataTable();
                linect.style.display="";
            });
            
            lineChart = new LineChart("#linechart",data);
            lineChart.initialize();


            dataTable = new SubDataTable("#data-table");

        });
        
        
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
</body>

</html>